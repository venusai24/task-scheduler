syntax = "proto3";
package sched;
option go_package = "github.com/venusai24/task-scheduler/proto";

enum GovernanceMode {
  ADVISORY_ONLY = 0;
  AUTONOMOUS = 1;
  HUMAN_GATE = 2;
}

enum TaskState {
  CREATED = 0;
  PENDING = 1;
  RUNNING = 2;
  COMPLETED = 3;
  FAILED = 4;
  ANALYZING = 5;
  NEEDS_APPROVAL = 6;
  AWAITING_PREREQUISITE = 7; // <--- ADDED: Waiting for dependency
}

message Task {
  string id = 1;
  string intent_yaml = 2;
  TaskState state = 3;
  repeated string logs = 4;
  GovernanceMode mode = 5;
  bool is_simulation = 6;
  int32 retry_count = 7;
  string ai_insight = 8;
  string pre_run_script = 9;   // Add this
  string post_run_script = 10; // Add this
  string depends_on = 11; // <--- ADDED: Parent Task ID
}

service SchedService {
  rpc SubmitIntent (SubmitRequest) returns (SubmitResponse);
  rpc GetTask (TaskRequest) returns (TaskResponse);
  rpc ApproveTask (ApproveRequest) returns (ApproveResponse); // <--- Add this
  rpc RollbackTask (RollbackRequest) returns (RollbackResponse); // <--- Add this
  rpc JoinCluster(JoinRequest) returns (JoinResponse);  // Add this
  rpc LeaveCluster(LeaveRequest) returns (LeaveResponse);
}

message ApproveRequest { string task_id = 1; } // <--- Add this
message ApproveResponse {                      // <--- Add this
    bool success = 1;
    string message = 2;
}

message RollbackRequest { string task_id = 1; } // <--- Add this
message RollbackResponse {                      // <--- Add this
    bool success = 1;
    string message = 2;
}

message SubmitRequest { 
  string yaml_content = 1;
  bool dry_run = 2; // <--- Add this
}
message SubmitResponse { string task_id = 1; }
message TaskRequest { string task_id = 1; }
message TaskResponse { Task task = 1; }
message JoinRequest {
  string node_id = 1;
  string address = 2;
}
message JoinResponse {
  bool success = 1;
  string message = 2;
}
message LeaveRequest {
  string node_id = 1;
}

message LeaveResponse {
  bool success = 1;
  string message = 2;
}